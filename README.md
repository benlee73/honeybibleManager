# Honey Bible Server

카카오톡 대화 CSV를 업로드하면 프론트 화면과 분석 API를 함께 제공하는
단일 서버입니다. 결과는 멤버별 이모티콘/날짜를 정리한 CSV로 내려받습니다.

## 꿀성경이란?

꿀성경은 매일 성경을 읽고 카카오톡 단톡방에서 인증하는 성경통독 프로그램입니다.

### 운영 방식

2026 꿀성경은 1년을 PART 1 · PART 2 · PART 3로 나누어 진행됩니다.

**2가지 트랙:**
- **Track 1. 성경일독**: 구약 → 신약 순으로 성경 전체를 1년 동안 통독
- **Track 2. 신약일독**: 신약만으로 1년 통독

**3개의 카톡방:**
- 성경일독 방 (Track 1만)
- 신약일독 방 (Track 2만)
- 투트랙 방 (Track 1 + Track 2 동시 진행)

### 인증 방법

매일 읽은 후 날짜 + 이모티콘으로 인증합니다. 이모티콘은 타인과 중복되지 않게 지정합니다.

**일반 방 (성경일독/신약일독):**
- 예시: `2/12🐷`

**투트랙 방:**
- 구약만 읽은 경우: `2/2 구약 🐷`
- 신약만 읽은 경우: `2/2 신약 🐷`
- 둘 다 읽은 경우: `2/2 구약 신약 🐷`

## 요구사항
- Python 3.12+
- Poetry

## 로컬 실행

```bash
poetry install
poetry run python server.py --port 8000
```

브라우저에서 `http://localhost:8000`을 열면 됩니다.

## 테스트

```bash
poetry run python -m pytest tests/ -v
```

## 엔드포인트
- POST /analyze (multipart/form-data)
  - 필드 이름: `file` (CSV 파일), `track_mode` (`"single"` 또는 `"dual"`, 기본값 `"single"`)
  - 응답: CSV 파일 다운로드 (UTF-8 with BOM)

## 정적 파일
- 프론트 파일은 `public/`에 위치합니다.
- `GET /`는 `public/index.html`을 제공합니다.

## 분석 규칙 요약
- 전체 CSV를 먼저 훑어 사람별 “지정 이모티콘”을 결정합니다.
- 해당 이모티콘이 포함된 메시지만 대상으로 날짜를 수집합니다.
- 날짜 파싱은 공백을 제거하고 범위/콤마 목록을 허용합니다.
  - 예: `2/4~5`, `2/4,5`, `2/4, 2/5`
- 날짜는 `M/D` 형식으로 정규화하고 월/일 기준으로 정렬합니다.
- 결과 CSV 컬럼: `이름`, `이모티콘`, 전체 날짜 컬럼 (해당 날짜 인증 시 `O` 표시)
- **투트랙 모드**: 메시지에 "구약"/"신약" 키워드가 포함된 경우 트랙별로 날짜를 분리 수집
  - 결과 CSV에 `트랙` 컬럼이 추가되며, 구약 블록 → 신약 블록 순으로 출력
  - 해당 트랙에 날짜가 없는 사용자는 그 블록에서 생략

## 배포 (방법 A: Render)
1) 이 저장소를 GitHub에 업로드합니다.
2) Render에서 **New Web Service**를 생성합니다.
3) GitHub 저장소를 연결합니다.
4) **Root Directory**는 저장소 루트로 설정합니다.
5) **Start Command**를 아래처럼 입력합니다.

```bash
python3 server.py --host 0.0.0.0 --port $PORT
```

배포가 완료되면 제공된 URL로 외부에서 접속할 수 있습니다.

## TODO
- ~~테스트 코드 추가~~
- ~~프로젝트 구조 리팩토링~~
- ~~로깅 추가~~
- ~~결과 포맷 변경~~
  - ~~as-is: 컬럼에 day1, day2 ...~~
  - ~~to-be: 컬럼에 2/2, 2/3 ...~~
- ~~투트랙 방 분석 지원~~
  - ~~구약/신약 트랙을 구분하여 날짜를 별도로 수집~~
- ~~중복 허용~~
  - ~~동일 날짜 다중 인증 시 1회 카운팅 (기존 동작 유지, 테스트 추가)~~
- 결과 csv 말고 엑셀같은 걸로 해서 더 이쁘게 보여주기